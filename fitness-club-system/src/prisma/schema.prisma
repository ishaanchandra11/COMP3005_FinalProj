generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  userId             Int              @id @default(autoincrement()) @map("user_id")
  email              String           @unique @db.VarChar(255)
  passwordHash       String           @map("password_hash") @db.VarChar(255)
  role               user_role
  createdAt          DateTime?        @default(now()) @map("created_at") @db.Timestamp(6)
  lastLogin          DateTime?        @map("last_login") @db.Timestamp(6)
  isActive           Boolean?         @default(true) @map("is_active")
  admins             Admin?
  audit_logs         audit_logs[]
  maintenanceReports MaintenanceLog[] @relation("MaintenanceReporter")
  members            Member?
  trainers           Trainer?

  @@index([email], map: "idx_users_email")
  @@index([role], map: "idx_users_role")
  @@map("users")
}

model Member {
  memberId              Int                       @id @default(autoincrement()) @map("member_id")
  user_id               Int                       @unique
  firstName             String                    @map("first_name") @db.VarChar(100)
  lastName              String                    @map("last_name") @db.VarChar(100)
  dateOfBirth           DateTime                  @map("date_of_birth") @db.Date
  gender                gender_type
  phoneNumber           String?                   @map("phone_number") @db.VarChar(20)
  emergencyContactName  String?                   @map("emergency_contact_name") @db.VarChar(100)
  emergencyContactPhone String?                   @map("emergency_contact_phone") @db.VarChar(20)
  joinDate              DateTime?                 @default(dbgenerated("CURRENT_DATE")) @map("join_date") @db.Date
  membershipStatus      membership_status?        @default(active) @map("membership_status")
  membershipEndDate     DateTime?                 @map("membership_end_date") @db.Date
  bills                 Bill[]
  classRegistrations    ClassRegistration[]
  fitnessGoals          FitnessGoal[]
  healthMetrics         HealthMetric[]
  users                 User                      @relation(fields: [user_id], references: [userId], onDelete: Cascade, onUpdate: NoAction)
  ptSessions            PersonalTrainingSession[]

  @@index([lastName, firstName], map: "idx_members_name")
  @@index([membershipStatus], map: "idx_members_status")
  @@index([user_id], map: "idx_members_user_id")
  @@map("members")
}

model Trainer {
  trainerId           Int                       @id @default(autoincrement()) @map("trainer_id")
  user_id             Int                       @unique
  firstName           String                    @map("first_name") @db.VarChar(100)
  lastName            String                    @map("last_name") @db.VarChar(100)
  specialization      String[]
  certificationNumber String?                   @map("certification_number") @db.VarChar(50)
  certificationExpiry DateTime?                 @map("certification_expiry") @db.Date
  hireDate            DateTime?                 @default(dbgenerated("CURRENT_DATE")) @map("hire_date") @db.Date
  hourlyRate          Decimal                   @default(0) @map("hourly_rate") @db.Decimal(10, 2)
  bio                 String?
  profileImageUrl     String?                   @map("profile_image_url") @db.VarChar(500)
  rating              Decimal?                  @default(0.00) @db.Decimal(3, 2)
  totalSessions       Int?                      @default(0) @map("total_sessions")
  classSchedules      ClassSchedule[]
  ptSessions          PersonalTrainingSession[]
  availability        TrainerAvailability[]
  users               User                      @relation(fields: [user_id], references: [userId], onDelete: Cascade, onUpdate: NoAction)

  @@index([rating(sort: Desc)], map: "idx_trainers_rating")
  @@index([specialization], map: "idx_trainers_specialization", type: Gin)
  @@index([user_id], map: "idx_trainers_user_id")
  @@map("trainers")
}

model Admin {
  adminId         Int              @id @default(autoincrement()) @map("admin_id")
  user_id         Int              @unique
  firstName       String           @map("first_name") @db.VarChar(100)
  lastName        String           @map("last_name") @db.VarChar(100)
  department      admin_department
  hireDate        DateTime?        @default(dbgenerated("CURRENT_DATE")) @map("hire_date") @db.Date
  users           User             @relation(fields: [user_id], references: [userId], onDelete: Cascade, onUpdate: NoAction)
  maintenanceLogs MaintenanceLog[]

  @@map("admins")
}

model FitnessGoal {
  goalId       Int          @id @default(autoincrement()) @map("goal_id")
  memberId     Int          @map("member_id")
  goalType     goal_type    @map("goal_type")
  targetValue  Decimal      @map("target_value") @db.Decimal(10, 2)
  targetDate   DateTime     @map("target_date") @db.Date
  currentValue Decimal?     @map("current_value") @db.Decimal(10, 2)
  status       goal_status? @default(active)
  createdAt    DateTime?    @default(now()) @map("created_at") @db.Timestamp(6)
  achievedAt   DateTime?    @map("achieved_at") @db.Timestamp(6)
  notes        String?
  member       Member       @relation(fields: [memberId], references: [memberId], onDelete: Cascade, onUpdate: NoAction)

  @@index([memberId, status], map: "idx_fitness_goals_member")
  @@index([status], map: "idx_fitness_goals_status")
  @@map("fitness_goals")
}

model HealthMetric {
  metricId               Int       @id @default(autoincrement()) @map("metric_id")
  memberId               Int       @map("member_id")
  recordedAt             DateTime? @default(now()) @map("recorded_at") @db.Timestamp(6)
  weight                 Decimal?  @db.Decimal(5, 2)
  height                 Decimal?  @db.Decimal(5, 2)
  bodyFatPercentage      Decimal?  @map("body_fat_percentage") @db.Decimal(5, 2)
  muscleMass             Decimal?  @map("muscle_mass") @db.Decimal(5, 2)
  restingHeartRate       Int?      @map("resting_heart_rate")
  bloodPressureSystolic  Int?      @map("blood_pressure_systolic")
  bloodPressureDiastolic Int?      @map("blood_pressure_diastolic")
  notes                  String?
  bmi                    Decimal?  @default(dbgenerated("\nCASE\n    WHEN ((weight IS NOT NULL) AND (height IS NOT NULL) AND (height > (0)::numeric)) THEN round((weight / power((height / (100)::numeric), (2)::numeric)), 2)\n    ELSE NULL::numeric\nEND")) @db.Decimal(5, 2)
  member                 Member    @relation(fields: [memberId], references: [memberId], onDelete: Cascade, onUpdate: NoAction)

  @@index([recordedAt(sort: Desc)], map: "idx_health_metrics_date")
  @@index([memberId, recordedAt(sort: Desc)], map: "idx_health_metrics_member")
  @@map("health_metrics")
}

model Room {
  roomId         Int                       @id @default(autoincrement()) @map("room_id")
  roomName       String                    @unique @map("room_name") @db.VarChar(100)
  roomType       room_type                 @map("room_type")
  capacity       Int
  hasEquipment   Boolean?                  @default(false) @map("has_equipment")
  isActive       Boolean?                  @default(true) @map("is_active")
  description    String?
  classSchedules ClassSchedule[]
  equipment      Equipment[]
  ptSessions     PersonalTrainingSession[]

  @@index([roomType], map: "idx_rooms_type")
  @@map("rooms")
}

model Equipment {
  equipmentId         Int               @id @default(autoincrement()) @map("equipment_id")
  roomId              Int?              @map("room_id")
  equipmentName       String            @map("equipment_name") @db.VarChar(100)
  equipmentType       equipment_type    @map("equipment_type")
  brand               String?           @db.VarChar(100)
  model               String?           @db.VarChar(100)
  purchaseDate        DateTime?         @map("purchase_date") @db.Date
  lastMaintenanceDate DateTime?         @map("last_maintenance_date") @db.Date
  nextMaintenanceDue  DateTime?         @map("next_maintenance_due") @db.Date
  status              equipment_status? @default(operational)
  serialNumber        String?           @map("serial_number") @db.VarChar(100)
  room                Room?             @relation(fields: [roomId], references: [roomId], onUpdate: NoAction)
  maintenanceLogs     MaintenanceLog[]

  @@index([roomId], map: "idx_equipment_room")
  @@index([status], map: "idx_equipment_status")
  @@map("equipment")
}

model GroupClass {
  classId           Int              @id @default(autoincrement()) @map("class_id")
  className         String           @map("class_name") @db.VarChar(100)
  classType         class_type       @map("class_type")
  description       String?
  difficultyLevel   difficulty_level @map("difficulty_level")
  durationMinutes   Int              @map("duration_minutes")
  maxCapacity       Int              @map("max_capacity")
  requiresEquipment Boolean?         @default(false) @map("requires_equipment")
  isActive          Boolean?         @default(true) @map("is_active")
  classSchedules    ClassSchedule[]

  @@map("group_classes")
}

model ClassSchedule {
  scheduleId         Int                 @id @default(autoincrement()) @map("schedule_id")
  classId            Int                 @map("class_id")
  trainerId          Int                 @map("trainer_id")
  roomId             Int                 @map("room_id")
  scheduledDate      DateTime            @map("scheduled_date") @db.Date
  startTime          DateTime            @map("start_time") @db.Time(6)
  endTime            DateTime            @map("end_time") @db.Time(6)
  currentCapacity    Int?                @default(0) @map("current_capacity")
  status             schedule_status?    @default(scheduled)
  cancellationReason String?             @map("cancellation_reason")
  notes              String?
  billItems          BillItem[]
  registrations      ClassRegistration[]
  groupClass         GroupClass          @relation(fields: [classId], references: [classId], onDelete: Cascade, onUpdate: NoAction)
  room               Room                @relation(fields: [roomId], references: [roomId], onUpdate: NoAction)
  trainer            Trainer             @relation(fields: [trainerId], references: [trainerId], onUpdate: NoAction)

  @@unique([roomId, scheduledDate, startTime, endTime], map: "no_room_conflict")
  @@unique([trainerId, scheduledDate, startTime, endTime], map: "no_trainer_conflict")
  @@index([scheduledDate, startTime], map: "idx_class_schedules_date")
  @@index([roomId, scheduledDate], map: "idx_class_schedules_room")
  @@index([status], map: "idx_class_schedules_status")
  @@index([trainerId, scheduledDate], map: "idx_class_schedules_trainer")
  @@map("class_schedules")
}

model PersonalTrainingSession {
  sessionId          Int             @id @default(autoincrement()) @map("session_id")
  memberId           Int             @map("member_id")
  trainerId          Int             @map("trainer_id")
  roomId             Int?            @map("room_id")
  scheduledDate      DateTime        @map("scheduled_date") @db.Date
  startTime          DateTime        @map("start_time") @db.Time(6)
  endTime            DateTime        @map("end_time") @db.Time(6)
  status             session_status? @default(scheduled)
  notes              String?
  memberFeedback     String?         @map("member_feedback")
  trainerNotes       String?         @map("trainer_notes")
  createdAt          DateTime?       @default(now()) @map("created_at") @db.Timestamp(6)
  cancelledAt        DateTime?       @map("cancelled_at") @db.Timestamp(6)
  cancellationReason String?         @map("cancellation_reason")
  billItems          BillItem[]
  member             Member          @relation(fields: [memberId], references: [memberId], onDelete: Cascade, onUpdate: NoAction)
  room               Room?           @relation(fields: [roomId], references: [roomId], onUpdate: NoAction)
  trainer            Trainer         @relation(fields: [trainerId], references: [trainerId], onUpdate: NoAction)

  @@unique([memberId, scheduledDate, startTime, endTime], map: "no_member_conflict")
  @@unique([trainerId, scheduledDate, startTime, endTime], map: "no_pt_trainer_conflict")
  @@index([scheduledDate, startTime], map: "idx_pt_sessions_date")
  @@index([memberId, scheduledDate(sort: Desc)], map: "idx_pt_sessions_member")
  @@index([status], map: "idx_pt_sessions_status")
  @@index([trainerId, scheduledDate(sort: Desc)], map: "idx_pt_sessions_trainer")
  @@map("personal_training_sessions")
}

model ClassRegistration {
  registrationId    Int                @id @default(autoincrement()) @map("registration_id")
  memberId          Int                @map("member_id")
  scheduleId        Int                @map("schedule_id")
  registrationDate  DateTime?          @default(now()) @map("registration_date") @db.Timestamp(6)
  attendance_status attendance_status? @default(registered)
  waitlistPosition  Int?               @map("waitlist_position")
  checkedInAt       DateTime?          @map("checked_in_at") @db.Timestamp(6)
  member            Member             @relation(fields: [memberId], references: [memberId], onDelete: Cascade, onUpdate: NoAction)
  schedule          ClassSchedule      @relation(fields: [scheduleId], references: [scheduleId], onDelete: Cascade, onUpdate: NoAction)

  @@unique([memberId, scheduleId], map: "unique_registration")
  @@index([memberId], map: "idx_class_registrations_member")
  @@index([scheduleId], map: "idx_class_registrations_schedule")
  @@map("class_registrations")
}

model TrainerAvailability {
  availabilityId Int         @id @default(autoincrement()) @map("availability_id")
  trainerId      Int         @map("trainer_id")
  dayOfWeek      day_of_week @map("day_of_week")
  startTime      DateTime    @map("start_time") @db.Time(6)
  endTime        DateTime    @map("end_time") @db.Time(6)
  isRecurring    Boolean?    @default(true) @map("is_recurring")
  effectiveDate  DateTime?   @default(dbgenerated("CURRENT_DATE")) @map("effective_date") @db.Date
  endDate        DateTime?   @map("end_date") @db.Date
  trainer        Trainer     @relation(fields: [trainerId], references: [trainerId], onDelete: Cascade, onUpdate: NoAction)

  @@index([effectiveDate, endDate], map: "idx_trainer_availability_dates")
  @@index([trainerId, dayOfWeek], map: "idx_trainer_availability_trainer")
  @@map("trainer_availability")
}

model Bill {
  billId        Int             @id @default(autoincrement()) @map("bill_id")
  memberId      Int             @map("member_id")
  generatedDate DateTime?       @default(dbgenerated("CURRENT_DATE")) @map("generated_date") @db.Date
  dueDate       DateTime        @map("due_date") @db.Date
  subtotal      Decimal         @default(0) @db.Decimal(10, 2)
  taxRate       Decimal?        @default(0.13) @map("tax_rate") @db.Decimal(5, 4)
  taxAmount     Decimal?        @default(dbgenerated("round((subtotal * tax_rate), 2)")) @map("tax_amount") @db.Decimal(10, 2)
  totalAmount   Decimal?        @default(dbgenerated("round((subtotal * ((1)::numeric + tax_rate)), 2)")) @map("total_amount") @db.Decimal(10, 2)
  status        bill_status?    @default(pending)
  paymentMethod payment_method? @map("payment_method")
  paidAt        DateTime?       @map("paid_at") @db.Timestamp(6)
  notes         String?
  items         BillItem[]
  member        Member          @relation(fields: [memberId], references: [memberId], onDelete: Cascade, onUpdate: NoAction)

  @@index([memberId, status], map: "idx_bills_member")
  @@index([status], map: "idx_bills_status")
  @@map("bills")
}

model BillItem {
  itemId           Int                      @id @default(autoincrement()) @map("item_id")
  billId           Int                      @map("bill_id")
  itemType         bill_item_type           @map("item_type")
  description      String
  quantity         Int                      @default(1)
  unitPrice        Decimal                  @map("unit_price") @db.Decimal(10, 2)
  subtotal         Decimal?                 @default(dbgenerated("round(((quantity)::numeric * unit_price), 2)")) @map("subtotal") @db.Decimal(10, 2)
  relatedSessionId Int?                     @map("related_session_id")
  relatedClassId   Int?                     @map("related_class_id")
  bill             Bill                     @relation(fields: [billId], references: [billId], onDelete: Cascade, onUpdate: NoAction)
  classSchedule    ClassSchedule?           @relation(fields: [relatedClassId], references: [scheduleId], onUpdate: NoAction)
  ptSession        PersonalTrainingSession? @relation(fields: [relatedSessionId], references: [sessionId], onUpdate: NoAction)

  @@map("bill_items")
}

model MaintenanceLog {
  logId            Int                   @id @default(autoincrement()) @map("log_id")
  equipmentId      Int                   @map("equipment_id")
  reportedBy       Int                   @map("reported_by")
  assignedTo       Int?                  @map("assigned_to")
  issueDescription String                @map("issue_description")
  priority         maintenance_priority? @default(medium)
  status           maintenance_status?   @default(reported)
  reportedDate     DateTime?             @default(now()) @map("reported_date") @db.Timestamp(6)
  resolvedDate     DateTime?             @map("resolved_date") @db.Timestamp(6)
  resolutionNotes  String?               @map("resolution_notes")
  cost             Decimal?              @db.Decimal(10, 2)
  admin            Admin?                @relation(fields: [assignedTo], references: [adminId], onUpdate: NoAction)
  equipment        Equipment             @relation(fields: [equipmentId], references: [equipmentId], onDelete: Cascade, onUpdate: NoAction)
  reporter         User                  @relation("MaintenanceReporter", fields: [reportedBy], references: [userId], onUpdate: NoAction)

  @@index([equipmentId], map: "idx_maintenance_logs_equipment")
  @@index([status], map: "idx_maintenance_logs_status")
  @@map("maintenance_logs")
}

model audit_logs {
  log_id     Int       @id @default(autoincrement())
  table_name String    @db.VarChar(100)
  record_id  Int
  action     String    @db.VarChar(20)
  changed_by Int?
  changed_at DateTime? @default(now()) @db.Timestamp(6)
  old_values Json?
  new_values Json?
  users      User?     @relation(fields: [changed_by], references: [userId], onDelete: NoAction, onUpdate: NoAction)
}

enum admin_department {
  operations
  maintenance
  billing
}

enum attendance_status {
  registered
  attended
  no_show
  cancelled
}

enum bill_item_type {
  membership
  personal_training
  class
  product
  other
}

enum bill_status {
  pending
  paid
  overdue
  cancelled
}

enum class_type {
  yoga
  pilates
  spin
  zumba
  HIIT
  strength
  cardio
  dance
}

enum day_of_week {
  MON
  TUE
  WED
  THU
  FRI
  SAT
  SUN
}

enum difficulty_level {
  beginner
  intermediate
  advanced
}

enum equipment_status {
  operational
  needs_maintenance
  under_repair
  out_of_service
}

enum equipment_type {
  cardio
  strength
  free_weights
  machine
}

enum gender_type {
  M
  F
  Other
}

enum goal_status {
  active
  achieved
  paused
  cancelled
}

enum goal_type {
  weight_loss
  muscle_gain
  endurance
  flexibility
  general_fitness
}

enum maintenance_priority {
  low
  medium
  high
  critical
}

enum maintenance_status {
  reported
  in_progress
  resolved
  cancelled
}

enum membership_status {
  active
  frozen
  cancelled
}

enum payment_method {
  credit_card
  debit
  cash
  e_transfer
}

enum room_type {
  gym_floor
  studio
  pool
  court
}

enum schedule_status {
  scheduled
  in_progress
  completed
  cancelled
}

enum session_status {
  scheduled
  completed
  cancelled
  no_show
}

enum user_role {
  member
  trainer
  admin
}
